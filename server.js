const express=require('express'),initSqlJs=require('sql.js'),bodyParser=require('body-parser'),cors=require('cors'),dayjs=require('dayjs'),fs=require('fs'),path=require('path');dayjs.extend(require('dayjs/plugin/utc'));dayjs.extend(require('dayjs/plugin/timezone'));dayjs.tz.setDefault("Asia/Shanghai");const app=express();const PORT=3000;let db=null;const DB_FILE=path.join(__dirname,'sales.db');async function initDatabase(){const SQL=await initSqlJs();if(fs.existsSync(DB_FILE)){const fileBuffer=fs.readFileSync(DB_FILE);db=new SQL.Database(fileBuffer);}else{db=new SQL.Database();}console.log('数据库初始化完成');}function saveDatabase(){if(!db)return;const data=db.export();const buffer=Buffer.from(data);fs.writeFileSync(DB_FILE,buffer);}app.use(cors());app.use(bodyParser.json({limit:'50mb'}));app.use(express.static('.'));initDatabase();app.get('/api/config/sizes',(req,res)=>{try{const result=db.exec("SELECT config_value FROM settings WHERE config_key = 'sizes'");const data=result.length>0?JSON.parse(result[0].values[0][0]):[];res.json(data);}catch(err){res.status(500).json({error:err.message});}});app.post('/api/config/sizes',(req,res)=>{try{db.run("INSERT INTO settings (config_key, config_value) VALUES ('sizes', ?) ON CONFLICT(config_key) DO UPDATE SET config_value = ?",[JSON.stringify(req.body),JSON.stringify(req.body)]);saveDatabase();res.json({success:true});}catch(err){res.status(500).json({error:err.message});}});app.get('/api/config/member_cols',(req,res)=>{try{const result=db.exec("SELECT config_value FROM settings WHERE config_key = 'member_cols'");const data=result.length>0?JSON.parse(result[0].values[0][0]):[];res.json(data);}catch(err){res.status(500).json({error:err.message});}});app.post('/api/config/member_cols',(req,res)=>{try{db.run("INSERT INTO settings (config_key, config_value) VALUES ('member_cols', ?) ON CONFLICT(config_key) DO UPDATE SET config_value = ?",[JSON.stringify(req.body),JSON.stringify(req.body)]);saveDatabase();res.json({success:true});}catch(err){res.status(500).json({error:err.message});}});app.get('/api/inventory',(req,res)=>{try{let sql='SELECT * FROM inventory WHERE 1=1';const params=[];const{page,pageSize,search,brand}=req.query;if(brand){sql+=' AND brand = ?';params.push(brand);}if(search){sql+=' AND (sku LIKE ? OR barcode LIKE ?)';params.push('%'+search+'%','%'+search+'%');}const result=db.exec(sql,params);const data=result.length>0?result[0].values.map(row=>({sku:row[0],barcode:row[1],brand:row[2],season:row[3],price:row[4],stock:JSON.parse(row[5]||'{}'),created_at:row[6]})):[];res.json(data);}catch(err){res.status(500).json({error:err.message});}});app.listen(PORT,()=>{console.log('力维路斯销售系统启动成功!');console.log('服务器运行在 http://localhost:'+PORT);});process.on('SIGINT',()=>{console.log('关闭服务器...');saveDatabase();process.exit(0);});
